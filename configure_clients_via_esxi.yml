---
- name: Configurar VMs de Clientes Linux en WS2 (Sin SSH)
  hosts: ws2
  gather_facts: no
  vars_files:
    - inventory/group_vars/linux_clients.yml

  tasks:
    - name: "Actualizar repositorios APT (solo una vez)"
      community.vmware.vmware_vm_shell:
        hostname: "{{ ansible_host }}"
        username: "{{ esxi_user }}"
        password: "{{ esxi_password }}"
        validate_certs: no
        vm_name: "{{ item }}"
        vm_username: "{{ vm_guest_admin_user }}"
        vm_password: "{{ vm_guest_admin_pass }}"
        vm_shell: "/bin/bash"
        vm_shell_args: "-c 'apt update'"
      loop: "{{ vms_clients_ws1 }}"

    - name: "Instalar software acad√©mico en {{ item_vm }}"
      community.vmware.vmware_vm_shell:
        hostname: "{{ ansible_host }}"
        username: "{{ esxi_user }}"
        password: "{{ esxi_password }}"
        validate_certs: no
        vm_name: "{{ item_vm }}"
        vm_username: "{{ vm_guest_admin_user }}"
        vm_password: "{{ vm_guest_admin_pass }}"
        vm_shell: "/bin/bash"
        vm_shell_args: "-c 'apt install -y {{ item_pkg }}'"
      loop: "{{ vms_clients_ws1 }}"
      loop_control:
        loop_var: item_vm
      with_nested:
        - "{{ academic_software_to_install }}"
        - "{{ vms_clients_ws1 }}"
      vars:
        item_pkg: "{{ item[0] }}"
        item_vm: "{{ item[1] }}"